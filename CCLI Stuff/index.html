<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CCLI ⇄ iSing matcher (with filters)</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; }
    h1 { margin-bottom: 10px; font-size: 1.25rem; }
    .filters { margin: 12px 0; }
    select { margin-right: 12px; padding: 4px; }
    #status { margin-top: 10px; padding: 8px; border-radius: 6px; background:#f6f6f6; font-size:0.95rem; }
  </style>
</head>
<body>
  <h1>CCLI ⇄ iSing Songs</h1>

  <div class="filters">
    <label for="keyFilter">Filter by Key:</label>
    <select id="keyFilter"><option value="">All</option></select>

    <label for="themeFilter">Filter by Theme:</label>
    <select id="themeFilter"><option value="">All</option></select>
  </div>

  <div id="status">Loading CSVs...</div>

  <table id="songsTable" class="display" style="width:100%; margin-top:8px;">
    <thead>
      <tr>
        <th>Title</th>
        <th>Artist</th>
        <th>Key</th>
        <th>Theme</th>
        <th>Date</th>
        <th>CCLI</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    let isingMap = {}, table=null;

    function normalizeTitle(s){
      if(!s) return '';
      s = String(s).normalize('NFKD').replace(/[\u0300-\u036f]/g,'');
      s = s.replace(/\(.*?\)|\[.*?\]|\{.*?\}/g,' ').replace(/\bfeat\.?[\s\w-]*|\blive\b|\bversion\b/gi,'');
      s = s.replace(/[^a-zA-Z0-9\s]/g,' ').replace(/\s+/g,' ').trim().toLowerCase();
      return s;
    }

    function parseDateSmart(s){
      if(!s) return null;
      const d = new Date(s); if(!isNaN(d)) return d;
      const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
      if(m){ let p1=parseInt(m[1],10),p2=parseInt(m[2],10),yy=parseInt(m[3],10); if(yy<100)yy+=2000; let day=p1,month=p2;if(month>12 && day<=12){month=p1;day=p2;} const d2=new Date(yy,month-1,day); if(!isNaN(d2)) return d2;}
      return null;
    }

    function setStatus(msg){ document.getElementById('status').innerHTML = msg; }

    // ---------- Load CSVs ----------
    Papa.parse('ising_songs.csv',{download:true, header:true, skipEmptyLines:true,
      complete: res=>{
        isingMap={};
        res.data.forEach(r=>{
          const title=(r.Title||'').trim(), key=(r.Key||'').trim(), artist=(r.Artist||'').trim();
          if(!title) return;
          isingMap[normalizeTitle(title)]={Title:title,Key:key,Artist:artist};
        });
        setStatus(`iSing loaded: ${Object.keys(isingMap).length} unique titles. Loading CCLI...`);
        loadCCLI();
      },
      error: err=>setStatus('Error loading iSing CSV: '+(err.message||err))
    });

    function loadCCLI(){
      Papa.parse('songs.csv',{download:true, header:true, skipEmptyLines:true,
        complete: res=>{
          const oneYearAgo=new Date(); oneYearAgo.setFullYear(oneYearAgo.getFullYear()-1);
          const mapped=res.data.map(r=>{
            const title=(r.Title||'').trim(), artist=(r.Artist||'').trim(),
                  key=(r.Key||'').trim(), theme=(r.Theme||'').trim(),
                  dateRaw=(r.Date||'').trim(), ccli=(r.CCLI||'').trim();
            return {Title:title,Artist:artist,Key:key,Theme:theme,DateRaw:dateRaw,CCLI:ccli};
          }).filter(r=>parseDateSmart(r.DateRaw)>=oneYearAgo);

          // Merge with iSing keys, remove duplicates
          const latestMap={};
          mapped.forEach(r=>{
            const nt=normalizeTitle(r.Title);
            const finalKey=r.Key|| (isingMap[nt]?isingMap[nt].Key:'');
            const finalArtist=r.Artist|| (isingMap[nt]?isingMap[nt].Artist:'');
            const dateObj=parseDateSmart(r.DateRaw);
            const dateISO=dateObj?dateObj.toISOString().slice(0,10):r.DateRaw||'';
            const merged={Title:r.Title,Artist:finalArtist,Key:finalKey,Theme:r.Theme,Date:dateISO,CCLI:r.CCLI};
            const dedupeKey=nt+'|'+finalArtist.toLowerCase();
            const existing=latestMap[dedupeKey];
            if(!existing) latestMap[dedupeKey]=merged;
            else if(dateObj && (!parseDateSmart(existing.Date)||dateObj>parseDateSmart(existing.Date))) latestMap[dedupeKey]=merged;
          });

          const finalRows=Object.values(latestMap);

          if(table) table.destroy();
          table=$('#songsTable').DataTable({
            data: finalRows,
            columns:[{data:"Title"},{data:"Artist"},{data:"Key"},{data:"Theme"},{data:"Date"},{data:"CCLI"}],
            order:[[0,'asc']]
          });

          setStatus(`Loaded ${finalRows.length} songs. Keys filled from iSing.`);

          // Populate filters
          populateFilter("Key","#keyFilter",finalRows);
          populateFilter("Theme","#themeFilter",finalRows);
        },
        error: err=>setStatus('Error loading CCLI CSV: '+(err.message||err))
      });
    }

    function populateFilter(field, selector, data){
      const unique=[...new Set(data.map(r=>r[field]).filter(Boolean))].sort();
      const dropdown=document.querySelector(selector);
      dropdown.innerHTML='<option value="">All</option>';
      unique.forEach(v=>{const opt=document.createElement("option"); opt.value=v; opt.textContent=v; dropdown.appendChild(opt);});
      $(selector).off('change').on('change',function(){
        const val=this.value;
        const colIndex=field==="Key"?2:3;
        table.column(colIndex).search(val?'^'+val+'$':'',true,false).draw();
      });
    }
  </script>
</body>
</html>
